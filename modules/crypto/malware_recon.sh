#!/bin/bash
# CTF_HELPER - Crypto in Malware & Reverse Engineering
# Focus: Heuristics, Constants, and API Pattern Recognition

echo -e "${C6}[MODULE: CRYPTO RECON / REVERSING]${NC}"
echo -e "Identifying algorithms via constants, S-Boxes, and API calls\n"

echo "1) Search for Crypto Constants (grep/yara)"
echo "2) Identify RC4 Loops (KSA/PRGA Patterns)"
echo "3) Windows Crypto API Monitor (Advapi32/CryptSP)"
echo "4) Find Compression Signatures (zlib, gzip, lznt1)"
echo "5) Entropy Analysis (Packed vs Encrypted)"
echo "0) Back to Crypto Menu"

echo -en "\n${C3}recon_helper > ${NC}"
read -r recon_opt

case $recon_opt in
    1)
        # HackTricks: "Fingerprint a cipher by searching constants"
        read -p "Target Binary Path: " bin_path
        echo -e "${C2}[*] Searching for known Crypto Constants...${NC}"
        # Searching for AES S-Box start bytes (0x63, 0x7c, 0x77, 0x7b...)
        grep -obUP "\x63\x7c\x77\x7b\xf2\x6b\x6f\xc5" "$bin_path" && echo "[!] Found AES S-Box!"
        # Searching for ChaCha20 "expand 32-byte k"
        strings "$bin_path" | grep -i "expand 32-byte k" && echo "[!] Found ChaCha20 Constant!"
        # Searching for TEA/XTEA constant (0x9E3779B9)
        grep -obUP "\xb9\x79\x37\x9e" "$bin_path" && echo "[!] Found TEA/XTEA Delta Constant!"
        ;;
    2)
        # HackTricks: "Two loops of 256 iterations hinting RC4"
        echo -e "${C2}[*] RC4 Recognition Heuristics:${NC}"
        echo " - Look for loops using 0x100 (256) as a counter."
        echo " - Look for an array of 256 bytes (State/S-Box) being swapped."
        
        ;;
    3)
        # HackTricks: "Second parameter is an ALG_ID"
        echo -e "${C2}[*] Windows Cryptography API (CAPI):${NC}"
        echo " - CryptDeriveKey / CryptCreateHash"
        echo " - Common ALG_IDs: 0x8003 (MD5), 0x8004 (SHA1), 0x6603 (3DES), 0x660e (AES-128)"
        echo " - Tip: Use 'ltrace' or 'api-monitor' to intercept these calls."
        ;;
    4)
        # HackTricks: "Look for magic bytes (zlib: 78 01, gzip: 1f 8b)"
        read -p "Target Binary Path: " bin_path
        echo -e "${C2}[*] Searching for Compression Headers...${NC}"
        binwalk "$bin_path"
        ;;
    5)
        # HackTricks: "Unpackers transform binary... check for RWX regions"
        read -p "Target Binary Path: " bin_path
        echo -e "${C2}[*] Calculating Section Entropy...${NC}"
        # High entropy (>7.0) usually means encrypted/compressed data
        if command -v diec &> /dev/null; then
            diec "$bin_path"
        else
            echo "Tip: Use 'Detect It Easy' (die) or 'pestudio' for entropy visualization."
        fi
        ;;
    0) return ;;
esac

echo -e "\n--------------------------------------------------"
read -p "Press Enter to continue..."
./modules/crypto/malware_recon.sh
