#!/bin/bash
# Module: Mobile Pentesting (HackTricks Methodology)
# Focus: Android (APK) & iOS (IPA) Analysis

function run_mobile_pentest() {
    print_banner
    echo -e "${C6}[MOBILE PENTESTING MODULE]${NC}"
    echo -e "Based on: https://book.hacktricks.xyz/mobile-pentesting/android-app-pentesting"
    echo -e "----------------------------------------------------------------------------"
    echo -e "1) üì¶  APK Decompilation (apktool)"
    echo -e "2) ‚òï  Convert APK to JAR (dex2jar)"
    echo -e "3) üïµÔ∏è   Search for Secrets (API Keys, Firebase, Endpoints)"
    echo -e "4) üìú  Analyze AndroidManifest.xml (Permissions/Exported Activities)"
    echo -e "5) üì±  ADB Quick Commands (Connect/Install/Shell)"
    echo -e "6) üçé  iOS IPA Basics (Unzip/Plist Analysis)"
    echo -e "0) ‚Ü©Ô∏è   Return to Main Menu"

    echo -ne "\n${C5}Mobile Selection: ${NC}"
    read mopt

    case $mopt in
        1)
            read -p "Path to APK: " apk
            [ -f "$apk" ] && apktool d "$apk" -o "${apk%.*}_out"
            echo -e "[*] Decompiled to ${apk%.*}_out/"
            ;;
        2)
            read -p "Path to APK: " apk
            if [ -f "$apk" ]; then
                echo -e "[*] Converting DEX to JAR..."
                d2j-dex2jar "$apk" -o "${apk%.*}.jar"
                echo -e "[*] Done! Open the .jar with JD-GUI or Bytecode Viewer."
            fi
            ;;
        3)
            read -p "Path to decompiled folder: " dir
            if [ -d "$dir" ]; then
                echo -e "\n[*] Searching for sensitive strings..."
                grep -rE "api_key|secret|password|aws_|firebase|http://" "$dir" | grep -v "res/"
            fi
            ;;
        4)
            read -p "Path to AndroidManifest.xml: " manifest
            if [ -f "$manifest" ]; then
                echo -e "\n[*] Checking for Exported Activities (Potential Entry Points):"
                grep "android:exported=\"true\"" "$manifest"
                echo -e "\n[*] Checking for Debuggable Flag:"
                grep "android:debuggable=\"true\"" "$manifest"
            fi
            ;;
        5)
            echo -e "\n[*] Common ADB Commands:"
            echo -e " - List devices: ${C4}adb devices${NC}"
            echo -e " - Install APK:  ${C4}adb install app.apk${NC}"
            echo -e " - Get Shell:    ${C4}adb shell${NC}"
            echo -e " - Logcat (Flag hunting): ${C4}adb logcat | grep -i flag${NC}"
            ;;
        6)
            read -p "Path to IPA: " ipa
            if [ -f "$ipa" ]; then
                echo -e "[*] Extracting IPA (it's just a ZIP)..."
                unzip "$ipa" -d "${ipa%.*}_extracted"
                echo -e "[*] Searching for Info.plist files..."
                find "${ipa%.*}_extracted" -name "Info.plist"
            fi
            ;;
        0) return ;;
        *) echo -e "${C1}Invalid selection.${NC}" ; sleep 1 ;;
    esac
    read -p "Press Enter to return..."
}
