#!/bin/bash
# CTF_HELPER - Malware & Delivery Stego Module
# Focus: Marker-delimited payloads and Polyglot Detection

source ./ctf_helper.sh

echo -e "${C6}[MODULE: MALWARE & NETWORK STEGO]${NC}"
echo -e "Detecting smuggled payloads in valid containers via markers & polyglots\n"

echo "1) Marker-Delimited Search (Custom Regex)"
echo "2) PowerShell/B64 Stager Scanner (Marker Hunt)"
echo "3) Trailing Bytes / Overlay Analysis (IEND/EOF)"
echo "4) Polyglot Check (Zip+Image, Script+Image)"
echo "5) Content-Type Mismatch (Network Triage)"
echo "0) Back to Stego Menu"

echo -en "\n${C3}malware_stego > ${NC}"
read mal_opt

case $mal_opt in
    1)
        # HackTricks: "Scan downloaded images for delimiter strings"
        read -p "Target file: " target
        read -p "Start Marker (e.g. <<start>>): " smark
        read -p "End Marker (e.g. <<end>>): " emark
        echo -e "${C2}[*] Searching for delimiters...${NC}"
        grep -oaP "$smark.*?$emark" "$target" | tr -d "$smark" | tr -d "$emark"
        ;;
    2)
        # HackTricks: "Look for unique marker strings embedded in file text"
        read -p "Target file: " target
        echo -e "${C2}[*] Scanning for common malware steganography markers...${NC}"
        grep -Ei "<<|>>|{{|}}|\[\[|\]\]" "$target" --color=always
        echo -e "${C3}[Tip] Look for Base64 blobs between these markers.${NC}"
        ;;
    3)
        # HackTricks: "Trailing bytes: data appended after formal end marker"
        read -p "Target file: " target
        echo -e "${C2}[*] Checking for data after standard EOF markers...${NC}"
        if [[ "$target" == *.png ]]; then
            echo "Searching after IEND (49 45 4e 44 ae 42 60 82)..."
            grep -abUoP "\x49\x45\x4e\x44\xae\x42\x60\x82.*" "$target" | tail -c +9 | xxd
        elif [[ "$target" == *.jpg ]]; then
            echo "Searching after EOI (ff d9)..."
            grep -abUoP "\xff\xd9.*" "$target" | tail -c +3 | xxd
        fi
        ;;
    4)
        # HackTricks: "Polyglots: files crafted to be valid under multiple parsers"
        read -p "Target file: " target
        echo -e "${C2}[*] Analyzing for Polyglot structures...${NC}"
        binwalk "$target"
        echo -e "${C3}[Tip] If it starts as PNG but contains a ZIP header (PK), it's a polyglot.${NC}"
        
        ;;
    5)
        # HackTricks: "Look for HTTP content-type mismatches"
        echo -e "${C2}[*] Network Delivery Triage Tips:${NC}"
        echo " - Check PCAP for responses with 'Content-Type: image/png'."
        echo " - If the BODY is high-entropy ASCII or pure Base64, it's a Smuggled Payload."
        echo " - Logic: The browser treats it as a broken image, but the malware script parses it."
        ;;
    0) return ;;
esac

echo -e "\n--------------------------------------------------"
read -p "Press Enter to continue..."
./modules/stego/malware_stego.sh
